<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.active4j.hr.activiti.dao.WorkflowDao">

	<select id="findFinishedTaskByUserName" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_hi_procinst p,
		act_hi_taskinst t
		WHERE
		b.ID = p.BUSINESS_KEY_
		AND p.PROC_INST_ID_ = t.PROC_INST_ID_
		AND t.ASSIGNEE_ = #{userName}
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
	</select>

	<select id="findFinishedTaskByALL" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_hi_procinst p,
		act_hi_taskinst t
		WHERE
		b.ID = p.BUSINESS_KEY_
		AND p.PROC_INST_ID_ = t.PROC_INST_ID_
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
	</select>

	<select id="findFinishedTaskSealByUserDept" resultType="HashMap">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME,
		f.sealtype

		FROM
		wf_base B
		left JOIN act_hi_procinst p on B.ID = p.BUSINESS_KEY_
		left JOIN act_hi_taskinst t on p.PROC_INST_ID_ = t.PROC_INST_ID_
		left JOIN flow_officalseal_approval f on b.BUSINESS_ID = f.ID
		where B.WORKFLOW_NAME = '双井公章申请'
		<if test="userDpet !=null and userDpet != ''">
			and b.APPLYER_DEPART = #{userDpet}
		</if>
		<if test="user_name != null and user_name != ''">
			and B.USER_NAME = #{user_name}
		</if>
		<if test="sealtype!=null and sealtype!=''">
			and f.sealtype = #{sealtype}
		</if>
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
	</select>

	<select id="findFinishedCarTaskByALL" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_hi_procinst p,
		act_hi_taskinst t
		WHERE
		b.ID = p.BUSINESS_KEY_
		AND p.PROC_INST_ID_ = t.PROC_INST_ID_
		AND b.WORKFLOW_NAME='车辆申请'
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
	</select>

	<select id="findGroupTaskStrsByUserName" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		act_ru_identitylink a
		LEFT JOIN act_ru_task t ON a.TASK_ID_ = t.ID_
		LEFT JOIN act_ru_execution e ON t.PROC_INST_ID_ = e.PROC_INST_ID_
		LEFT JOIN wf_base B ON E.BUSINESS_KEY_ = B.ID
		WHERE
		a.USER_ID_ = #{userName}
		AND a.type_ = 'candidate'
		AND e.BUSINESS_KEY_ IS NOT NULL
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		ORDER BY
		B.APPLY_DATE DESC
	</select>


	<select id="findGroupTaskIdByBusinessKey" resultType="java.lang.String">
		SELECT
			DISTINCT a.TASK_ID_
		FROM
			act_ru_identitylink a
		LEFT JOIN act_ru_task t ON a.TASK_ID_ = t.ID_
		LEFT JOIN act_ru_execution e ON t.PROC_INST_ID_ = e.PROC_INST_ID_
		LEFT JOIN wf_base B ON E.BUSINESS_KEY_ = B.ID
		WHERE
			a.USER_ID_ = #{userName}
		AND a.type_ = 'candidate'
		AND b.ID = #{businessKey}
		ORDER BY
			B.APPLY_DATE DESC
	</select>

	<select id="findTaskStrsByUserName" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_ru_execution e,
		act_ru_task t
		WHERE
		b.ID = e.BUSINESS_KEY_
		AND e.PROC_INST_ID_ = t.PROC_INST_ID_
		AND t.ASSIGNEE_ = #{userName}
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
	</select>

	<select id="findGoodsTaskStrsByUserName" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_ru_execution e,
		act_ru_task t
		WHERE
		b.ID = e.BUSINESS_KEY_
		AND e.PROC_INST_ID_ = t.PROC_INST_ID_
		AND t.ASSIGNEE_ = #{userName}
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		and WORKFLOW_NAME in ('物品借用申请','临时餐卡申请')
		order by b.APPLY_DATE desc
	</select>


	<select id="findFinishedTaskByUserDept" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_hi_procinst p,
		act_hi_taskinst t,
		sys_user u,
		sys_depart d
		WHERE
		b.ID = p.BUSINESS_KEY_
		AND p.PROC_INST_ID_ = t.PROC_INST_ID_
		and b.USER_NAME=u.USER_NAME
		and u.DEPT_ID=d.ID
		and d.`NAME` = #{userDpet}
		and B.WORKFLOW_NAME=#{workflow_name}

		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
	</select>
	<select id="findFinishedTaskCarByUserDept" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		select * from
		(
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_hi_procinst p,
		sys_user u,
		sys_depart d
		WHERE
		b.ID = p.BUSINESS_KEY_
		AND b.USER_NAME=u.USER_NAME
		and u.DEPT_ID=d.ID
		and d.`NAME` = #{dept}
		and b.status=3
		AND b.WORKFLOW_NAME='车辆申请'
		<if test="categoryId!=null and categoryId!=''">and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
		) as a
	</select>


	<select id="findFinishedTaskGoodsByUserDept" resultType="com.active4j.hr.activiti.entity.WorkflowBaseEntity">
		SELECT DISTINCT
		B.ID,
		B.APPLY_DATE,
		B.APPLY_NAME,
		B.APPLYER_DEPART,
		B.BUSINESS_ID,
		B.CATEGORY_ID,
		B.CREATE_DATE,
		B.CREATE_NAME,
		B. LEVEL,
		B. NAME,
		B.PROJECT_NO,
		B. STATUS,
		B.USER_NAME,
		B.WORKFLOW_ID,
		B.WORKFLOW_NAME
		FROM
		wf_base b,
		act_hi_procinst p,
		act_hi_taskinst t,
		sys_user u,
		sys_depart d
		WHERE
		b.ID = p.BUSINESS_KEY_
		AND p.PROC_INST_ID_ = t.PROC_INST_ID_
		and b.USER_NAME=u.USER_NAME
		and u.DEPT_ID=d.ID

		and B.WORKFLOW_NAME="物品借用申请"
		<if test="userDpet !=null and userDpet != ''">
			and d.`NAME` = #{userDpet}
		</if>
		<if test="categoryId!=null and categoryId!=''">
			and b.CATEGORY_ID = #{categoryId}
		</if>
		<if test="projectNo!=null and projectNo!=''">
			and b.PROJECT_NO = #{projectNo}
		</if>
		<if test="name!=null and name!=''">
			and b.NAME like concat('%',#{name},'%')
		</if>
		<if test="applyName!=null and applyName!=''">
			and b.APPLY_NAME = #{applyName}
		</if>
		<if test="applyerDepart!=null and applyerDepart!=''">
			and b.APPLYER_DEPART = #{applyerDepart}
		</if>
		<if test="applyDateStart!=null and applyDateStart!=''">
			and b.APPLY_DATE &gt;= #{applyDateStart}
		</if>
		<if test="applyDateEnd!=null and applyDateEnd!=''">
			and b.APPLY_DATE &lt;= #{applyDateEnd}
		</if>
		order by b.APPLY_DATE desc
	</select>

</mapper>
